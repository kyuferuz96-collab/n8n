version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: n8n-unlocked-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-n8n}
      - POSTGRES_USER=${POSTGRES_USER:-n8n}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  n8n-unlocked:
    image: ${DOCKER_USERNAME}/n8n-unlocked:${N8N_VERSION:-unlocked-latest}
    container_name: n8n-unlocked
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "5678:5678"
    environment:
      # ========================================
      # åŸºç¡€é…ç½®
      # ========================================
      - N8N_HOST=${N8N_HOST:-0.0.0.0}
      - N8N_PORT=5678
      # Bind on IPv4 as well (fixes localhost/IPv4 access when default is IPv6-only '::')
      - N8N_LISTEN_ADDRESS=0.0.0.0
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:?N8N_ENCRYPTION_KEY is required}

      # ========================================
      # æ•°æ®åº“ï¼ˆPostgresï¼‰
      # ========================================
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-n8n}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}

      # ========================================
      # ğŸ”“ AI åŠŸèƒ½é…ç½®
      # ========================================
      - N8N_AI_ENABLED=true
      - N8N_AI_ANTHROPIC_KEY=${N8N_AI_ANTHROPIC_KEY}
      - N8N_AI_OPENAI_KEY=${N8N_AI_OPENAI_KEY:-}
      # n8n å®˜æ–¹ AI Assistant æœåŠ¡åœ°å€ï¼ˆé€šå¸¸ç•™ç©ºå³å¯ï¼‰
      - N8N_AI_ASSISTANT_BASE_URL=${N8N_AI_ASSISTANT_BASE_URL:-}
      # å·¥ä½œæµç”Ÿæˆå™¨ç›´è¿ LLM çš„è‡ªå®šä¹‰ API Base URLï¼ˆå¯é€‰ï¼‰
      - N8N_AI_LLM_BASE_URL=${N8N_AI_LLM_BASE_URL:-}
      - N8N_AI_PROVIDER=${N8N_AI_PROVIDER:-anthropic}
      - N8N_AI_MODEL_NAME=${N8N_AI_MODEL_NAME:-}

      # ========================================
      # æ•°æ®æŒä¹…åŒ–
      # ========================================
      - N8N_USER_FOLDER=/home/node/.n8n

      # ========================================
      # å…¶ä»–é…ç½®
      # ========================================
      - TZ=${TIMEZONE:-Asia/Shanghai}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      
    volumes:
      # æ•°æ®æŒä¹…åŒ–
      - n8n_data:/home/node/.n8n
      
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:5678/healthz', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1));\"",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  n8n_data:
    driver: local
  postgres_data:
    driver: local

# ========================================
# ä½¿ç”¨è¯´æ˜
# ========================================
#
# 1. å¤åˆ¶ .env.example ä¸º .env å¹¶å¡«å†™é…ç½®
# 2. è®¾ç½® N8N_AI_ANTHROPIC_KEY ä¸ºä½ çš„ API Key
# 3. å¯é€‰ï¼šè®¾ç½® N8N_AI_LLM_BASE_URL ä½¿ç”¨è‡ªå®šä¹‰ LLM API Base URL
# 4. å¯é€‰ï¼šè®¾ç½® N8N_AI_PROVIDER å’Œ N8N_AI_MODEL_NAME
#
# å¯åŠ¨æœåŠ¡ï¼š
#   docker compose up -d
#
# æŸ¥çœ‹æ—¥å¿—ï¼š
#   docker compose logs -f
#
# åœæ­¢æœåŠ¡ï¼š
#   docker compose down
#
# è®¿é—®åœ°å€ï¼š
#   http://localhost:5678

